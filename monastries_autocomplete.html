<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monasteries Data Entry</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #121212;
    color: #e0e0e0;
    min-height: 80vh;
}
h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #ffffff;
}
form {
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    width: 1190px;
    max-width: 90vw;
    margin: 0 auto;
}
.form-row {
    display: flex;
    align-items: center;
    margin-top: 15px;
    flex-wrap: wrap;
}
.form-row label {
    margin-left: 50px;
    width: 480px;
    font-weight: bold;
}
.form-row input {
    width: 260px;
    padding: 5px 10px;
    margin-right: 10px;
    margin-bottom: 5px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #2a2a2a;
    color: #fff;
}
.form-row input::placeholder {
    color: #aaa;
}
.form-row button {
    padding: 5px 10px;
    margin-right: 10px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    height: 28px;
}
.form-row button:hover {
    background: #0056b3;
}
.delete-btn {
    background: #dc3545;
    margin-left: 5px;
}
.delete-btn:hover {
    background: #a71d2a;
}
.subfields {
    margin-left: 0px;
    margin-top: 10px;
}
.subfields div {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
    flex-wrap: nowrap;
    white-space: nowrap;
}
.subfields input {
    width: 100px;
    margin-right: 0px;
    margin-left: 0px;
    padding: 4px 6px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #2a2a2a;
    color: #fff;
}
.submit-btn {
    margin-top: 20px;
    padding: 10px 20px;
    width: 150px;
    font-size: 16px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    margin-left: 50px;
    cursor: pointer;
}
.submit-btn:hover {
    background: #1e7e34;
}
.dynamic-row {
    display: flex;
    align-items: center;
    margin-left: 530px;
    margin-top: 5px;
    gap: 5px;
}
</style>
</head>

<body>

<h2>Monasteries Data Entry Form</h2>

<form id="monasteriesForm">

    <!-- Label -->
    <div class="form-row">
        <label>Label:</label>
        <input name="L_lang[]", placeholder="Language code (e.g. en, de)">
        <input name="L_value[]", placeholder="Label value">
        <button type="button" onclick="addLangField('labels-container', 'Len')">Add</button>
    </div>
    <div id="labels-container"></div>

    <!-- Description -->
    <div class="form-row">
        <label>Description:</label>
        <input name="D_lang[]", placeholder="Language code (e.g. en, de)">
        <input name="D_value[]", placeholder="Label value">
        <button type="button" onclick="addLangField('descriptions-container', 'Den')">Add</button>
    </div>
    <div id="descriptions-container"></div>

    <!-- Aliases -->
    <div class="form-row">
        <label>Also known as / Aliases:</label>
        <input name="A_lang[]", placeholder="Language code (e.g. en, de)">
        <input name="A_value[]", placeholder="Label value">
        <button type="button" onclick="addLangField('aliases-container', 'Aen')">Add</button>
    </div>
    <div id="aliases-container"></div>

    <div class="form-row">
        <label>P131 - Research projects that contributed to this data set:</label>
        <input name="P131" autocomplete="off">
    </div>

    <div class="form-row">
        <label>P2 – Instance of:</label>
        <input name="P2" autocomplete="off">
    </div>

    <div class="form-row">
        <label>P746 – Religious order:</label>
        <input name="P746" autocomplete="off">
        <button type="button" onclick="addField('P746_subfields', 'Qualifier')">Add Qualifier</button>
        <button type="button" onclick="addField('P746_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P746_subfields"></div>

    <div class="form-row">
        <label>P662 – Dedicatee:</label>
        <input name="P662" autocomplete="off">
        <button type="button" onclick="addField('P662_subfields', 'Qualifier')">Add Qualifier</button>
        <button type="button" onclick="addField('P662_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P662_subfields"></div>

    <div class="form-row">
        <label>P208 – Address / Real estate:</label>
        <input name="P208" autocomplete="off">
        <button type="button" onclick="addField('P208_subfields', 'Qualifier')">Add Qualifier</button>
        <button type="button" onclick="addField('P208_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P208_subfields"></div>

    <button class="submit-btn" type="submit">Next</button>
</form>

<script>
const FG_API =
  "https://database.factgrid.de/w/api.php?action=wbsearchentities&format=json&language=en&type=item&origin=*";

async function factgridSearch(query) {
  const res = await fetch(FG_API + "&search=" + encodeURIComponent(query));
  const json = await res.json();
  return json.search || [];
}

function attachFactGridAutocomplete(input) {
    const dropdown = document.createElement("div");
    dropdown.className = "autocomplete-dropdown";
    dropdown.style.position = "absolute";
    dropdown.style.background = "#2a2a2a";
    dropdown.style.color = "#fff";
    dropdown.style.border = "1px solid #444";
    dropdown.style.zIndex = "1000";
    dropdown.style.overflowX = "auto";
    dropdown.style.whiteSpace = "nowrap";
    dropdown.style.display = "none";
    dropdown.style.maxWidth = "500px"; // optional max width

    document.body.appendChild(dropdown); // keep it in body for absolute positioning

    let lastQuery = "";

    input.addEventListener("input", async () => {
        const q = input.value.trim();
        if (q.length < 1 || q === lastQuery) {
            dropdown.style.display = "none";
            return;
        }
        lastQuery = q;

        const results = await factgridSearch(q);
        dropdown.innerHTML = "";
        if (results.length === 0) {
            dropdown.style.display = "none";
            return;
        }

        results.forEach(r => {
            const opt = document.createElement("div");
            opt.textContent = `${r.label} (${r.id})`;
            opt.style.padding = "5px 10px";
            opt.style.cursor = "pointer";
            dropdown.appendChild(opt);

            opt.addEventListener("click", () => {
                input.value = r.id;
                dropdown.style.display = "none";
            });
        });

        // Position dropdown below input
        const rect = input.getBoundingClientRect();
        dropdown.style.top = rect.bottom + window.scrollY + "px";
        dropdown.style.left = rect.left + window.scrollX + "px";
        dropdown.style.minWidth = rect.width + "px";

        dropdown.style.display = "block";
    });

    // Hide dropdown if click outside
    document.addEventListener("click", e => {
        if (!dropdown.contains(e.target) && e.target !== input) {
            dropdown.style.display = "none";
        }
    });

    // Reposition on window resize/scroll
    window.addEventListener("scroll", () => dropdown.style.display = "none");
    window.addEventListener("resize", () => dropdown.style.display = "none");
}



document.querySelectorAll(
  'input[name="P131"], input[name="P2"], input[name="P746"], input[name="P208"]'
).forEach(attachFactGridAutocomplete);



function addField(containerId, type) {
    const container = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    if (type === 'Qualifier') {
        div.innerHTML = `Begin Date: <input type="date" name="${containerId}_begin[]"> End Date: <input type="date" name="${containerId}_end[]"> <button type="button" class="delete-btn" onclick="this.parentNode.remove()">Delete</button>`;
    } else {
    div.innerHTML = `
      <select name="${containerId}_pid[]">
        <option value="P471">P471 – Klosterdatenbank ID</option>
        <option value="P146">P146 – Online Information</option>
      </select>
      <input type="text" name="${containerId}_ref[]">
      <button type="button" class="delete-btn" onclick="this.parentNode.remove()">Remove</button>
    `;
  }
    container.appendChild(div);
}

function addLangField(containerId, type) {
    const container = document.getElementById(containerId);

    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `
        <input type="text" name="${type}_lang[]" placeholder="Language code (e.g., en)"
      style="width:260px;background:#2a2a2a;color:#fff;border:1px solid #444;border-radius:4px;padding:5px 10px;">
    <input type="text" name="${type}_value[]" placeholder="Value"
      style="width:260px;background:#2a2a2a;color:#fff;border:1px solid #444;border-radius:4px;padding:5px 10px;">
    <button type="button" class="delete-btn" onclick="this.parentNode.remove()">Delete</button>
  `;
  container.appendChild(div);
}

document.getElementById("monasteriesForm").onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const data = {};

  // Normal single-value fields
  ["P131", "P2", "P746", "P662", "P208"].forEach(field => {
    let value = fd.get(field);
    if (!value) return;

    // For P662, wrap value in quotes
    if (field === "P662") {
        value = `"${value}"`;
    }

    // Collect subfields (qualifiers/references)
    const subContainer = field + "_subfields";
    const subRows = fd.getAll(subContainer + "_pid[]").map((pid, i) => {
        const val = fd.getAll(subContainer + "_ref[]")[i] || "";
        return pid + " " + val;
    });

    const beginDates = fd.getAll(subContainer + "_begin[]");
    const endDates = fd.getAll(subContainer + "_end[]");
    const qualifiers = [];
    beginDates.forEach((b, i) => {
        const eDate = endDates[i] || "";
        qualifiers.push(`P49 ${b} P50 ${eDate}`);
    });

    // Merge all subfields in a single string
    const allSubs = [...qualifiers, ...subRows].join("  ").trim();
    data[field] = allSubs ? `${value} ${allSubs}` : value;
  });

  // Labels, descriptions, aliases
  ["L", "D", "A"].forEach(prefix => {
    const langs = fd.getAll(`${prefix}_lang[]`);
    const values = fd.getAll(`${prefix}_value[]`);
    langs.forEach((lang, i) => {
      if (!lang || !values[i]) return;
      const key = `${prefix}${lang.trim()}`;
      if (!data[key]) data[key] = [];
      data[key].push(`"${values[i]}"`);
    });
  });

  sessionStorage.setItem("monasteriesData", JSON.stringify(data));
  window.location.href = "complexes_autocomplete.html";
};


</script>

</body>
</html>
