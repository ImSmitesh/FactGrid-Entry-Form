<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monasteries Data Entry</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #121212;
  color: #e0e0e0;
  min-height: 80vh;
}

h2 {
  text-align: center; /* top center horizontally */
  margin-bottom: 20px;
  color: #ffffff;
}


.form-container {
  display: flex;
  justify-content: center; /* horizontally center the form */
}

form {
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
  width: 670px;
  max-width: 90vw;
  margin: 0 auto; /* center horizontally */
}

.form-row {
  display: flex;
  align-items: center;
  margin-top: 15px;
}

.form-row label {
  width: 250px;
  font-weight: bold;
}

.form-row input {
  width: 260px;
  padding: 5px 8px;
  margin-right: 10px;
  border: 1px solid #444;
  border-radius: 4px;
  background: #2a2a2a;
  color: #fff;
}

.form-row input::placeholder {
  color: #aaa;
}

.form-row button {
  width: 120px;
  padding: 5px 10px;
  margin-right: 5px;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}

.form-row button:hover {
  background: #0056b3;
}

.subfields {
  margin-left: 250px; /* aligns with input field */
  margin-top: 10px;
}

.subfields div {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 5px;
  flex-wrap: nowrap;
  white-space: nowrap;   /* prevents text from wrapping */
}

.subfields input {
  width: 100px;
  margin-right: 10px;
  padding: 4px 6px;
  border: 1px solid #444;
  border-radius: 4px;
  background: #2a2a2a;
  color: #fff;
}

.remove-btn {
  background: #dc3545;
  margin-left: 5px;
  padding: 4px 8px;
}

.remove-btn:hover {
  background: #a71d2a;
}

.submit-btn {
  margin-top: 20px;
  padding: 10px 20px;
  width: 150px;
  font-size: 16px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.submit-btn:hover {
  background: #1e7e34;
}


</style>
</head>

<body>

<h2>Complexes Data Entry Form</h2>

<form id="complexesForm">

    <div class="form-row">
        <label>P48 - Coordinate location:</label>
        <input name="P48_complex" type="text" autocomplete="off" placeholder="@latitude/longitude (e.g. @52.12345/9.12345)">
    </div>

    <div class="form-row">
        <label>P83 - Place of address:</label>
        <input name="P83" autocomplete="off">
    </div>

    <div class="form-row">
        <label>P2 - Instance of:</label>
        <input name="P2_complex" value="Building Complex" readonly>
    </div>

    <div class="form-row">
        <label>P1003 - Diocese:</label>
        <input name="P1003" autocomplete="off">
        <button type="button" onclick="addField('P1003_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P1003_subfields"></div>

    <div class="form-row">
        <label>P131 - Research projects:</label>
        <input name="P131" autocomplete="off">
        <button type="button" onclick="addField('P131_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P131_subfields"></div>

    <div class="form-row">
        <label>P1095 - Users:</label>
        <input name="P1095" autocomplete="off">
        <button type="button" onclick="addField('P1095_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P1095_subfields"></div>

    <br></br>
    <h3 style="text-align: center;">Add Identifiers</h3>

    <div class="form-row">
        <label>P471 - Klosterdatenbank ID:</label>
        <input name="P471" autocomplete="off">
        <button type="button" onclick="addField('P471_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P471_subfields"></div>

    <div class="form-row">
        <label>P76 - GND:</label>
        <input name="P76" autocomplete="off">
        <button type="button" onclick="addField('P76_subfields', 'Reference')">Add Reference</button>
    </div>
    <div class="subfields" id="P76_subfields"></div>

<button type="submit" class="submit-btn">Save V1 Command</button>

</form>

<script>

const FG_API =
  "https://database.factgrid.de/w/api.php?action=wbsearchentities&format=json&language=en&type=item&origin=*";

async function factgridSearch(query) {
  const res = await fetch(FG_API + "&search=" + encodeURIComponent(query));
  const json = await res.json();
  return json.search || [];
}

function attachFactGridAutocomplete(input) {
    const dropdown = document.createElement("div");
    dropdown.className = "autocomplete-dropdown";
    dropdown.style.position = "absolute";
    dropdown.style.background = "#2a2a2a";
    dropdown.style.color = "#fff";
    dropdown.style.border = "1px solid #444";
    dropdown.style.zIndex = "1000";
    dropdown.style.overflowX = "auto";
    dropdown.style.whiteSpace = "nowrap";
    dropdown.style.display = "none";
    dropdown.style.maxWidth = "500px"; // optional max width

    document.body.appendChild(dropdown); // keep it in body for absolute positioning

    let lastQuery = "";

    input.addEventListener("input", async () => {
        const q = input.value.trim();
        if (q.length < 1 || q === lastQuery) {
            dropdown.style.display = "none";
            return;
        }
        lastQuery = q;

        const results = await factgridSearch(q);
        dropdown.innerHTML = "";
        if (results.length === 0) {
            dropdown.style.display = "none";
            return;
        }

        results.forEach(r => {
            const opt = document.createElement("div");
            opt.textContent = `${r.label} (${r.id})`;
            opt.style.padding = "5px 10px";
            opt.style.cursor = "pointer";
            dropdown.appendChild(opt);

            opt.addEventListener("click", () => {
                input.value = r.id;
                dropdown.style.display = "none";
            });
        });

        // Position dropdown below input
        const rect = input.getBoundingClientRect();
        dropdown.style.top = rect.bottom + window.scrollY + "px";
        dropdown.style.left = rect.left + window.scrollX + "px";
        dropdown.style.minWidth = rect.width + "px";

        dropdown.style.display = "block";
    });

    // Hide dropdown if click outside
    document.addEventListener("click", e => {
        if (!dropdown.contains(e.target) && e.target !== input) {
            dropdown.style.display = "none";
        }
    });

    // Reposition on window resize/scroll
    window.addEventListener("scroll", () => dropdown.style.display = "none");
    window.addEventListener("resize", () => dropdown.style.display = "none");
}


document.querySelectorAll(
  'input[name="P83"], input[name="P1003"], input[name="P131"], input[name="P1095"]'
).forEach(attachFactGridAutocomplete);



function addField(containerId, type) {
  const container = document.getElementById(containerId);
  const div = document.createElement('div');

  if (type === 'Qualifier') {
    div.innerHTML = `
      Begin Date: <input type="date" name="${containerId}_begin[]">
      End Date: <input type="date" name="${containerId}_end[]">
      <button type="button" class="remove-btn" onclick="this.parentNode.remove()">Remove</button>
    `;
  } else {
    div.innerHTML = `
      <select name="${containerId}_pid[]">
        <option value="P471">P471 – Klosterdatenbank ID</option>
        <option value="P146">P146 – Online Information</option>
      </select>
      <input type="text" name="${containerId}_ref[]">
      <button type="button" class="remove-btn" onclick="this.parentNode.remove()">Remove</button>
    `;
  }
  
  container.appendChild(div);
}

function collectFormData(form) {
  const fd = new FormData(form);
  const data = {};
  for (const [k, v] of fd.entries()) {
    if (k.endsWith("[]")) {
      const key = k.replace("[]", "");
      if (!data[key]) data[key] = [];
      data[key].push(v);
    } else {
      data[k] = v;
    }
  }
  return data;
}

document.getElementById("complexesForm").onsubmit = e => {
  e.preventDefault();

  const complexesData = collectFormData(e.target);
  const monasteriesData = JSON.parse(sessionStorage.getItem("monasteriesData") || "{}");

  // Build an array of property entries instead of object
  const entries = [];

  const addEntriesFromData = data => {
    Object.keys(data).forEach(key => {
      // Skip subfield arrays
      if (/_subfields_pid$|_subfields_ref$|_subfields_begin$|_subfields_end$/.test(key)) return;

      // Base property name
      const baseKey = key.replace(/_complex$/, "");
      entries.push({ key: baseKey, originalKey: key, value: data[key] });
    });
  };

  addEntriesFromData(monasteriesData);
  addEntriesFromData(complexesData);

  let v1 = "CREATE\n";
  const lines = [];

  entries.forEach(entry => {
    const { key: baseKey, originalKey, value } = entry;
    let line = `LAST\t${baseKey}\t${value}`;

    // Attach references (handle both normal and "_complex" naming)
    const pidKeys = [
      baseKey + "_subfields_pid",
      baseKey + "_subfields_complex_pid"
    ];
    const refKeys = [
      baseKey + "_subfields_ref",
      baseKey + "_subfields_complex_ref"
    ];
    pidKeys.forEach((pidKey, idx) => {
      const refKey = refKeys[idx];
      if (monasteriesData[pidKey] || complexesData[pidKey]) {
        const refArray = mergedDataLookup(pidKey) || [];
        const valArray = mergedDataLookup(refKey) || [];
        refArray.forEach((pid, i) => {
          const refVal = valArray[i] || "";
          line += `\t${pid} \t${refVal}`;
        });
      }
    });

    // Attach qualifiers (dates)
    const beginKeys = [
      baseKey + "_subfields_begin",
      baseKey + "_subfields_complex_begin"
    ];
    const endKeys = [
      baseKey + "_subfields_end",
      baseKey + "_subfields_complex_end"
    ];
    beginKeys.forEach((beginKey, idx) => {
      const endKey = endKeys[idx];
      const beginArray = mergedDataLookup(beginKey) || [];
      const endArray = mergedDataLookup(endKey) || [];
      beginArray.forEach((b, i) => {
        const eDate = endArray[i] || "";
        line += `\tP49\t ${b} \tP50\t ${eDate}`;
      });
    });

    lines.push(line);
  });

  v1 += lines.join("\n");

  const blob = new Blob([v1], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "factgrid_v1.txt";
  a.click();
  URL.revokeObjectURL(url);

  // Helper to check both data sources
  function mergedDataLookup(k) {
    return complexesData[k] || monasteriesData[k] || [];
  }
};


</script>

</body>
</html>

